<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NBA Fantasy ‚Äî Salary Cup Edition</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üèÄ</text></svg>">
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
  :root {
    --bg-deep: #0a0e1a;
    --bg-card: #111827;
    --bg-row-even: #0f1525;
    --bg-row-hover: #1a2340;
    --accent-orange: #f97316;
    --accent-blue: #3b82f6;
    --accent-gold: #fbbf24;
    --accent-silver: #94a3b8;
    --accent-bronze: #d97706;
    --text-primary: #f1f5f9;
    --text-secondary: #94a3b8;
    --text-muted: #475569;
    --border: #1e293b;
    --green: #22c55e;
    --red: #ef4444;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--bg-deep);
    color: var(--text-primary);
    font-family: 'DM Sans', sans-serif;
    min-height: 100vh;
    overflow-x: hidden;
  }

  body::after {
    content: '';
    position: fixed;
    inset: 0;
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.04'/%3E%3C/svg%3E");
    pointer-events: none;
    z-index: 1000;
  }

  .header {
    position: relative;
    padding: 2.5rem 2rem 1.5rem;
    text-align: center;
    overflow: hidden;
  }

  .header::before {
    content: '';
    position: absolute;
    top: -60%;
    left: 50%;
    transform: translateX(-50%);
    width: 800px;
    height: 400px;
    background: radial-gradient(ellipse, rgba(249, 115, 22, 0.15) 0%, transparent 70%);
    pointer-events: none;
  }

  .header-top {
    font-family: 'Bebas Neue', sans-serif;
    font-size: clamp(1.1rem, 2.5vw, 1.4rem);
    letter-spacing: 0.15em;
    color: var(--accent-orange);
    animation: fadeDown 0.6s ease-out;
  }

  .header h1 {
    font-family: 'Bebas Neue', sans-serif;
    font-size: clamp(2.5rem, 6vw, 4.2rem);
    letter-spacing: 0.04em;
    line-height: 1;
    margin-top: 0.15rem;
    background: linear-gradient(135deg, #fff 0%, var(--accent-orange) 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    animation: fadeDown 0.6s ease-out 0.1s both;
  }

  .header-meta {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.6rem;
    margin-top: 0.7rem;
    font-size: 0.8rem;
    color: var(--text-muted);
    flex-wrap: wrap;
    animation: fadeDown 0.6s ease-out 0.2s both;
  }

  .header-meta .dot-sep {
    width: 4px;
    height: 4px;
    border-radius: 50%;
    background: var(--text-muted);
  }

  .update-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.4rem;
    color: var(--text-secondary);
  }

  .pulse-dot {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: var(--green);
    animation: pulse 2s infinite;
  }

  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.3; }
  }

  @keyframes fadeDown {
    from { opacity: 0; transform: translateY(-12px); }
    to { opacity: 1; transform: translateY(0); }
  }

  @keyframes fadeUp {
    from { opacity: 0; transform: translateY(12px); }
    to { opacity: 1; transform: translateY(0); }
  }

  /* Loading */
  .loading {
    text-align: center;
    padding: 4rem 1rem;
    color: var(--text-muted);
  }

  .loading .spinner {
    width: 36px;
    height: 36px;
    border: 3px solid var(--border);
    border-top-color: var(--accent-orange);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    margin: 0 auto 1rem;
  }

  @keyframes spin { to { transform: rotate(360deg); } }

  .error-msg {
    text-align: center;
    padding: 3rem 1rem;
    color: var(--red);
  }

  /* Controls */
  .controls {
    max-width: 1200px;
    margin: 1.2rem auto 0;
    padding: 0 1.5rem;
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
    animation: fadeUp 0.5s ease-out 0.3s both;
  }

  .search-box {
    flex: 1;
    min-width: 220px;
    position: relative;
  }

  .search-box svg {
    position: absolute;
    left: 14px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--text-muted);
    width: 18px;
    height: 18px;
  }

  .search-box input {
    width: 100%;
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 0.75rem 1rem 0.75rem 2.8rem;
    color: var(--text-primary);
    font-family: 'DM Sans', sans-serif;
    font-size: 0.9rem;
    outline: none;
    transition: border-color 0.2s, box-shadow 0.2s;
  }

  .search-box input::placeholder { color: var(--text-muted); }
  .search-box input:focus {
    border-color: var(--accent-orange);
    box-shadow: 0 0 0 3px rgba(249, 115, 22, 0.1);
  }

  /* Table */
  .table-container {
    max-width: 1200px;
    margin: 1.5rem auto 3rem;
    padding: 0 1.5rem;
    animation: fadeUp 0.5s ease-out 0.4s both;
  }

  .table-wrapper {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 14px;
    overflow-x: auto;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    min-width: 820px;
  }

  thead th {
    padding: 0.8rem 0.6rem;
    font-size: 0.68rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--text-muted);
    text-align: center;
    border-bottom: 1px solid var(--border);
    position: sticky;
    top: 0;
    background: var(--bg-card);
    z-index: 2;
    white-space: nowrap;
  }

  thead th:nth-child(1) { text-align: center; width: 55px; padding-left: 1rem; }
  thead th:nth-child(2) { text-align: left; min-width: 180px; }
  thead th:nth-child(3) { text-align: center; width: 60px; }
  thead th.th-total { color: var(--accent-orange); }
  thead th.th-today { color: var(--accent-blue) !important; }
  thead th.th-future { opacity: 0.35; }

  tbody tr {
    transition: background 0.15s;
    cursor: default;
  }

  tbody tr:nth-child(even) { background: var(--bg-row-even); }
  tbody tr:hover { background: var(--bg-row-hover); }

  tbody td {
    padding: 0.65rem 0.6rem;
    font-size: 0.85rem;
    border-bottom: 1px solid rgba(30, 41, 59, 0.5);
    text-align: center;
    white-space: nowrap;
  }

  tbody td:nth-child(1) { padding-left: 1rem; }
  tbody td:nth-child(2) { text-align: left; }

  .rank {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 1.2rem;
    color: var(--text-secondary);
  }

  .medal {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 30px;
    height: 30px;
    border-radius: 7px;
    font-family: 'Bebas Neue', sans-serif;
    font-size: 1rem;
  }

  .medal-1 { background: rgba(251, 191, 36, 0.15); color: var(--accent-gold); }
  .medal-2 { background: rgba(148, 163, 184, 0.12); color: var(--accent-silver); }
  .medal-3 { background: rgba(217, 119, 6, 0.12); color: var(--accent-bronze); }

  .player-info { display: flex; flex-direction: column; gap: 0.05rem; }
  .player-name { font-weight: 600; font-size: 0.85rem; }
  .team-name { font-size: 0.72rem; color: var(--text-muted); }

  .movement {
    display: inline-flex;
    align-items: center;
    gap: 0.15rem;
    font-size: 0.75rem;
    font-weight: 600;
    padding: 0.12rem 0.45rem;
    border-radius: 5px;
  }

  .mov-up { color: var(--green); background: rgba(34, 197, 94, 0.1); }
  .mov-down { color: var(--red); background: rgba(239, 68, 68, 0.1); }
  .mov-same { color: var(--text-muted); }

  .day-pts { font-size: 0.85rem; color: var(--text-secondary); font-weight: 500; }
  .day-pts.empty { color: var(--text-muted); opacity: 0.4; }
  .day-pts.today { color: var(--accent-blue); font-weight: 700; }

  .weekly-total {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 1.3rem;
    color: var(--accent-orange);
  }

  /* Pagination */
  .pagination {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 0.5rem;
    padding: 1.2rem;
    border-top: 1px solid var(--border);
    flex-wrap: wrap;
  }

  .page-btn {
    background: transparent;
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 0.5rem 0.85rem;
    color: var(--text-secondary);
    font-family: 'DM Sans', sans-serif;
    font-size: 0.85rem;
    cursor: pointer;
    transition: all 0.2s;
  }

  .page-btn:hover { border-color: var(--accent-orange); color: var(--text-primary); }
  .page-btn.active { background: var(--accent-orange); border-color: var(--accent-orange); color: #000; font-weight: 700; }
  .page-btn:disabled { opacity: 0.3; pointer-events: none; }

  .page-info {
    font-size: 0.8rem;
    color: var(--text-muted);
    padding: 0 0.5rem;
  }

  .footer {
    text-align: center;
    padding: 1rem;
    font-size: 0.75rem;
    color: var(--text-muted);
  }

  .footer span { color: var(--accent-orange); }

  .empty-state {
    padding: 3rem 1rem;
    text-align: center;
    color: var(--text-muted);
  }

  .empty-state .icon { font-size: 2.5rem; margin-bottom: 0.8rem; }

  @media (max-width: 900px) {
    .table-wrapper { -webkit-overflow-scrolling: touch; }
    .controls { flex-direction: column; }
  }

  @media (max-width: 500px) {
    .header { padding: 2rem 1rem 1rem; }
    .header h1 { font-size: 2.2rem; }
  }

  .table-wrapper::-webkit-scrollbar { height: 6px; }
  .table-wrapper::-webkit-scrollbar-track { background: var(--bg-deep); }
  .table-wrapper::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
  .table-wrapper::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }

  /* Highlight search match */
  mark {
    background: rgba(249, 115, 22, 0.3);
    color: var(--text-primary);
    border-radius: 2px;
    padding: 0 1px;
  }
</style>
</head>
<body>

<div class="header">
  <div class="header-top">NBA Fantasy ‚Äî Salary Cup Edition</div>
  <h1>Weekly Ranking</h1>
  <div class="header-meta" id="headerMeta">
    <span id="weekInfo">Loading...</span>
  </div>
</div>

<div class="controls">
  <div class="search-box">
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3" stroke-linecap="round"/></svg>
    <input type="text" id="searchInput" placeholder="Search player or team name...">
  </div>
</div>

<div class="table-container">
  <div class="table-wrapper">
    <div id="loadingArea" class="loading">
      <div class="spinner"></div>
      <p>Loading rankings...</p>
    </div>
    <table id="dataTable" style="display:none">
      <thead>
        <tr id="tableHead"></tr>
      </thead>
      <tbody id="tableBody"></tbody>
    </table>
    <div class="pagination" id="pagination"></div>
  </div>
  <div class="footer">Data from <span>es.nbafantasy.nba.com</span> ¬∑ Automated daily via GitHub Actions</div>
</div>

<script>
const PER_PAGE = 50;
let allData = [];
let filteredData = [];
let currentPage = 1;
let meta = {};

async function loadData() {
  try {
    const resp = await fetch('data.json');
    if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
    const json = await resp.json();
    meta = json.meta;
    allData = json.rankings;
    filteredData = [...allData];

    updateHeader();
    buildTableHead();
    renderTable();

    document.getElementById('loadingArea').style.display = 'none';
    document.getElementById('dataTable').style.display = '';
  } catch (err) {
    document.getElementById('loadingArea').innerHTML =
      `<div class="error-msg">
        <p>‚ö†Ô∏è Could not load ranking data.</p>
        <p style="font-size:0.8rem;margin-top:0.5rem;color:var(--text-muted)">
          The scraper may not have run yet. Trigger it manually from GitHub Actions.
        </p>
      </div>`;
    console.error('Load error:', err);
  }
}

function updateHeader() {
  const weekStart = formatDate(meta.week_start);
  const weekEnd = formatDate(meta.week_end);
  const generated = meta.generated_at ? new Date(meta.generated_at).toLocaleString('en-GB', {
    day: 'numeric', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit', timeZone: 'Europe/Madrid'
  }) : '';

  document.getElementById('headerMeta').innerHTML = `
    <span>Week ${meta.phase || '?'} ¬∑ ${weekStart} ‚Äì ${weekEnd}</span>
    <span class="dot-sep"></span>
    <span>${(meta.total_players || 0).toLocaleString()} players</span>
    <span class="dot-sep"></span>
    <span class="update-badge"><span class="pulse-dot"></span> Updated daily at 8:00 AM CEST</span>
  `;
}

function formatDate(str) {
  if (!str) return '';
  const d = new Date(str + 'T00:00:00');
  return d.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' });
}

function buildTableHead() {
  const labels = meta.day_labels || ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
  const todayIdx = meta.today_index ?? -1;

  let html = '<th>#</th><th>Player / Team</th><th>Mov</th>';
  labels.forEach((label, i) => {
    let cls = '';
    if (i === todayIdx) cls = 'th-today';
    else if (i > todayIdx) cls = 'th-future';
    html += `<th class="${cls}">${label}</th>`;
  });
  html += '<th class="th-total">Total</th>';

  document.getElementById('tableHead').innerHTML = html;
}

function getRankHTML(rank) {
  if (rank <= 3) return `<span class="medal medal-${rank}">${rank}</span>`;
  return `<span class="rank">${rank}</span>`;
}

function getMovHTML(mov) {
  if (mov > 0) return `<span class="movement mov-up">‚ñ≤ ${mov}</span>`;
  if (mov < 0) return `<span class="movement mov-down">‚ñº ${Math.abs(mov)}</span>`;
  return `<span class="movement mov-same">‚Äì</span>`;
}

function getDayHTML(pts, dayIndex) {
  const todayIdx = meta.today_index ?? -1;
  if (pts === null || pts === undefined) return `<td><span class="day-pts empty">‚Äî</span></td>`;
  const cls = dayIndex === todayIdx ? 'day-pts today' : 'day-pts';
  return `<td><span class="${cls}">${pts}</span></td>`;
}

function highlightMatch(text, query) {
  if (!query) return text;
  const escaped = query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
  const regex = new RegExp(`(${escaped})`, 'gi');
  return text.replace(regex, '<mark>$1</mark>');
}

let searchQuery = '';

function renderTable() {
  const tbody = document.getElementById('tableBody');
  const start = (currentPage - 1) * PER_PAGE;
  const end = start + PER_PAGE;
  const pageData = filteredData.slice(start, end);

  if (pageData.length === 0) {
    tbody.innerHTML = `<tr><td colspan="${4 + 7}"><div class="empty-state"><div class="icon">üîç</div><p>No results found</p></div></td></tr>`;
    document.getElementById('pagination').innerHTML = '';
    return;
  }

  tbody.innerHTML = pageData.map((d, i) => {
    const playerName = highlightMatch(d.p, searchQuery);
    const teamName = highlightMatch(d.t, searchQuery);
    const days = d.d || [null,null,null,null,null,null,null];

    return `
    <tr style="animation: fadeUp 0.25s ease-out ${i * 0.015}s both">
      <td>${getRankHTML(d.r)}</td>
      <td>
        <div class="player-info">
          <span class="player-name">${playerName}</span>
          <span class="team-name">${teamName}</span>
        </div>
      </td>
      <td>${getMovHTML(d.m)}</td>
      ${days.map((pts, di) => getDayHTML(pts, di)).join('')}
      <td><span class="weekly-total">${d.w}</span></td>
    </tr>`;
  }).join('');

  renderPagination();
}

function renderPagination() {
  const totalPages = Math.ceil(filteredData.length / PER_PAGE);
  const pag = document.getElementById('pagination');

  if (totalPages <= 1) { pag.innerHTML = ''; return; }

  let html = '';
  html += `<button class="page-btn" onclick="goToPage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>‚Äπ</button>`;

  const pages = [];
  pages.push(1);
  if (currentPage > 3) pages.push('...');
  for (let p = Math.max(2, currentPage - 1); p <= Math.min(totalPages - 1, currentPage + 1); p++) pages.push(p);
  if (currentPage < totalPages - 2) pages.push('...');
  if (totalPages > 1) pages.push(totalPages);

  pages.forEach(p => {
    if (p === '...') {
      html += `<span class="page-info">‚Ä¶</span>`;
    } else {
      html += `<button class="page-btn ${p === currentPage ? 'active' : ''}" onclick="goToPage(${p})">${p}</button>`;
    }
  });

  html += `<button class="page-btn" onclick="goToPage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>‚Ä∫</button>`;
  html += `<span class="page-info">${filteredData.length.toLocaleString()} players</span>`;

  pag.innerHTML = html;
}

function goToPage(p) {
  const totalPages = Math.ceil(filteredData.length / PER_PAGE);
  if (p < 1 || p > totalPages) return;
  currentPage = p;
  renderTable();
  document.querySelector('.table-wrapper').scrollIntoView({ behavior: 'smooth', block: 'start' });
}

document.getElementById('searchInput').addEventListener('input', function(e) {
  searchQuery = e.target.value.toLowerCase().trim();
  if (searchQuery === '') {
    filteredData = [...allData];
  } else {
    filteredData = allData.filter(d =>
      d.p.toLowerCase().includes(searchQuery) ||
      d.t.toLowerCase().includes(searchQuery)
    );
  }
  currentPage = 1;
  renderTable();
});

// Init
loadData();
</script>

</body>
</html>
